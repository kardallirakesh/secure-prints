<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecurePrint | Universal Node</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --neon: #38bdf8; --bg: #050505; --success: #4ade80; }
        body {
            margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg);
            background-image: radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%);
            height: 100vh; display: flex; justify-content: center; align-items: center; color: white; overflow: hidden;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 30px;
            padding: 40px; width: 380px; text-align: center; box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        .switcher { display: flex; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 15px; margin-bottom: 25px; }
        .switcher button {
            flex: 1; padding: 12px; border: none; background: transparent;
            color: #888; cursor: pointer; border-radius: 10px; font-weight: bold; transition: 0.3s;
        }
        .switcher button.active { background: rgba(56, 189, 248, 0.1); color: var(--neon); }
        .id-badge { font-size: 42px; font-weight: 900; text-shadow: 0 0 20px var(--neon); margin: 20px 0; font-family: monospace; letter-spacing: 5px; }
        input, .btn-main { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; font-size: 16px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; }
        input { background: rgba(255,255,255,0.05); color: white; text-align: center; }
        .btn-main { background: var(--neon); color: black; font-weight: bold; cursor: pointer; border: none; transition: 0.3s; }
        .btn-main:hover { opacity: 0.8; transform: scale(0.98); }
        .status { font-size: 10px; letter-spacing: 2px; color: var(--neon); text-transform: uppercase; margin-bottom: 15px; font-weight: bold; }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 10px; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

    <div class="glass-card">
        <div class="switcher">
            <button id="sTab" onclick="setMode('sender')">I AM SENDING</button>
            <button id="rTab" onclick="setMode('receiver')" class="active">I AM PRINTING</button>
        </div>

        <div id="ui-receiver">
            <div class="status" id="r-status">CONNECTING TO NETWORK...</div>
            <div id="my-id" class="id-badge">----</div>
            <div id="file-ready" style="display:none">
                <p id="file-info" style="color:var(--success); font-size: 0.9rem; margin-bottom: 20px;"></p>
                <button class="btn-main" onclick="printAndWipe()">PRINT & SHRED DATA</button>
            </div>
        </div>

        <div id="ui-sender" style="display: none;">
            <div class="status" id="s-status">SECURE TUNNEL IDLE</div>
            <input type="text" id="targetCode" placeholder="ENTER 5-DIGIT CODE" maxlength="5">
            <input type="file" id="fileInput" accept="application/pdf">
            <button class="btn-main" id="sendBtn" onclick="startTransfer()">PUSH TO PRINTER</button>
            <div class="progress-bar" id="pBar"><div class="progress-fill" id="pFill"></div></div>
        </div>
    </div>

    <script>
        // 1. High-Stability Config using Google STUN
        const peer = new Peer({
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        let activeBlobUrl = null;

        // UI Switcher Logic
        function setMode(m) {
            document.getElementById('ui-sender').style.display = m === 'sender' ? 'block' : 'none';
            document.getElementById('ui-receiver').style.display = m === 'receiver' ? 'block' : 'none';
            document.getElementById('sTab').className = m === 'sender' ? 'active' : '';
            document.getElementById('rTab').className = m === 'receiver' ? 'active' : '';
        }

        // 2. RECEIVER: Explicitly wait for registration
        peer.on('open', (id) => {
            // Generate a short 5-character display code
            document.getElementById('my-id').innerText = id.substring(0, 5).toUpperCase();
            document.getElementById('r-status').innerText = "ONLINE: READY TO RECEIVE";
            console.log("Successfully registered with ID:", id);
        });

        peer.on('connection', (conn) => {
            document.getElementById('r-status').innerText = "CONNECTION DETECTED!";
            conn.on('data', (data) => {
                const blob = new Blob([data.file], { type: 'application/pdf' });
                activeBlobUrl = URL.createObjectURL(blob); // Hold only in RAM
                document.getElementById('file-info').innerText = "ðŸ“„ FILE: " + data.name;
                document.getElementById('file-ready').style.display = 'block';
                document.getElementById('r-status').innerText = "DATA SECURED IN RAM";
            });
        });

        // 3. SENDER: Use a 'Retry' logic to bypass network lag
        async function startTransfer() {
            const code = document.getElementById('targetCode').value.trim().toLowerCase();
            const file = document.getElementById('fileInput').files[0];
            const status = document.getElementById('s-status');

            if (!code || !file) return alert("Select file and enter code!");

            status.innerText = "DRILLING TUNNEL...";
            
            // Connect with a 5-second connection watchdog
            const conn = peer.connect(code, { reliable: true });

            conn.on('open', async () => {
                status.innerText = "TUNNEL OPEN: SENDING...";
                const buffer = await file.arrayBuffer();
                conn.send({ file: buffer, name: file.name });
                status.innerText = "âœ… DELIVERED";
            });

            // Handle the specific 'peer-unavailable' error
            peer.on('error', (err) => {
                if(err.type === 'peer-unavailable') {
                    status.innerText = "âŒ ERROR: PRINTER NOT FOUND";
                    alert("The printing computer isn't ready. Check the code and try again.");
                }
            });
        }

        // 4. PRINT & SHRED: The Security Core
        function printAndWipe() {
            const pWin = window.open(activeBlobUrl, '_blank');
            if (pWin) {
                pWin.focus();
                const check = setInterval(() => {
                    if (pWin.closed) {
                        clearInterval(check);
                        URL.revokeObjectURL(activeBlobUrl); // Shred data from RAM
                        alert("SECURITY: Data wiped from system.");
                        window.location.reload(); 
                    }
                }, 1000);
            }
        }
   </script>
</body>
</html>